name: OWASP ZAP Security Scan

on: [push, pull_request]

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # é˜²æ­¢é•¿æ—¶é—´é˜»å¡

    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3  # å‡çº§åˆ°æœ€æ–°checkoutç‰ˆæœ¬
        with:
          fetch-depth: 0  # ç¡®ä¿åŒ…å«.zapç›®å½•

      - name: ğŸ³ å‡†å¤‡ZAPç¯å¢ƒ
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§é•œåƒ
          docker rm -f zap-scanner || true
          docker rmi owasp/zap2docker-* || true
          
          # æ‹‰å–æ–°å®˜æ–¹é•œåƒ
          docker pull owasp/zap-stable || docker pull owasp/zap-weekly
          docker tag owasp/zap-stable ghcr.io/zaproxy-action/zap-stable

      - name: ğŸ¯ æœåŠ¡å¯è¾¾æ€§æ£€æŸ¥
        run: |
          if ! curl -Isf --retry 3 --retry-delay 5 http://47.129.5.86:8080; then
              echo "::error::ç›®æ ‡æœåŠ¡ä¸å¯è¾¾"
              exit 1
          fi

      - name: ğŸ•·ï¸ æ‰§è¡Œå…¨é¢æ‰«æ
        uses: zaproxy/action-full-scan@v1.0.0
        with:
          target: "http://47.129.5.86:8080"
          docker_image: "owasp/zap-stable"  # æ˜¾å¼æŒ‡å®šé•œåƒ
          cmd_options: "-I -T 120 -j"      # å‚æ•°è¯´æ˜ï¼š
            # -I å¿½ç•¥è­¦å‘Š
            # -T 120ç§’è¶…æ—¶
          # -j ç”ŸæˆJSONæŠ¥å‘Š
          rules_file_name: ".zap/rules.tsv"
          alert_overrides: ".zap/alerts.conf"  # å‘Šè­¦çº§åˆ«è¦†ç›–æ–‡ä»¶

      - name: ğŸ“Š ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š
        run: |
          # è½¬æ¢JSONæŠ¥å‘Šä¸ºå¤šæ ¼å¼
          zap-convert -i zap-report.json -t html -o report.html
          zap-convert -i zap-report.json -t md -o report.md
          echo "æŠ¥å‘Šç”Ÿæˆå®Œæˆ â†’ $(ls -lh report.*)"

      - name: ğŸ“¤ ä¸Šä¼ æ‰«æç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: security-report-$(date +%s)
          path: |
            report.html
            report.md
            zap-report.json
            zap_scan.log