name: BaitMate OWASP Security Scan

on:
  push:
    branches:
      - master

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # å¢åŠ å…¨å±€è¶…æ—¶é™åˆ¶

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ç¡®ä¿.zapç›®å½•è¢«å®Œæ•´æ‹‰å–

      - name: ğŸ³ æ¸…ç†æ—§é•œåƒ
        run: |
          docker rm -f zap-runner || true
          docker rmi owasp/zap2docker-stable || true
          docker rmi owasp/zap2docker-weekly || true

      - name: ğŸ”„ æ‹‰å–æ­£ç¡®é•œåƒ
        run: |
          docker pull owasp/zap-stable
          docker tag owasp/zap-stable ghcr.io/zaproxy-action/zap-stable  # åŒ¹é…Actioné¢„æœŸé•œåƒå

      - name: ğŸ•µï¸ é¢„æ£€ç›®æ ‡æœåŠ¡
        run: |
          curl --retry 3 --retry-delay 5 -IsSf http://47.129.5.86:8080 > /dev/null
          echo "âœ… ç›®æ ‡æœåŠ¡å¯è¾¾"

      - name: ğŸš€ æ‰§è¡Œæ·±åº¦æ‰«æ
        uses: zaproxy/action-full-scan@v1.0.0
        env:
          ZAP_PATH: /zap/wrk/
        with:
          target: "http://47.129.5.86:8080"
          cmd_options: "-I -T 120 -j"  # 120ç§’è¶…æ—¶+JSONæŠ¥å‘Š
          rules_file_name: ".zap/rules.tsv"
          context_file: ".zap/context.context"  # å¯é€‰ä¸Šä¸‹æ–‡é…ç½®

      - name: ğŸ“Š èšåˆæŠ¥å‘Š
        run: |
          zap-convert -i zap-report.json -t html -o zap-report.html
          zap-convert -i zap-report.json -t md -o zap-report.md

      - name: ğŸ“¤ ä¸Šä¼ ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ZAP-Security-Report-$(date +%s)
          path: |
            zap_scan.log
            zap-report.*
            .zap/