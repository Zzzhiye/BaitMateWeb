name: OWASP ZAP Security Scan

on: [push, pull_request]

jobs:
  zap-scan:
    runs-on: ubuntu-24.04  # æ˜¾å¼æŒ‡å®šæ–°ç‰ˆé•œåƒ
    timeout-minutes: 45

    steps:
      - name: ğŸ› ï¸ Checkout with Depth
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ä¼˜åŒ–å¤§ä»“åº“æ£€å‡ºé€Ÿåº¦

      - name: ğŸ¯ Service Health Check
        uses: actions/http-request@v1.13.0  # GitHubå®˜æ–¹ç»´æŠ¤çš„HTTPæ£€æŸ¥
        with:
          endpoint: http://47.129.5.86:8080
          max-attempts: 3
          retry-delay: 5000

      - name: ğŸ” ZAP Full Scan
        uses: zaproxy/action-full-scan@v1.0.0  # ç¡®è®¤å­˜åœ¨çš„ç¨³å®šç‰ˆæœ¬
        with:
          target: 'http://47.129.5.86:8080'
          cmd_options: '-I -T 180 -j'
          rules_file_name: '.zap/rules.tsv'
          docker_options: '--memory 4g'  # å†…å­˜é™åˆ¶

      - name: ğŸ“Š Report Generation
        run: |
          # å®‰è£…æŠ¥å‘Šå·¥å…·
          sudo apt-get -qq install jq
          zap-convert -i zap-report.json -t html -o report.html

      - name: ğŸ“¤ Artifact Upload
        uses: actions/upload-artifact@v4.3.3
        with:
          name: security-report-${{ github.run_number }}
          path: |
            report.html
            zap-report.json